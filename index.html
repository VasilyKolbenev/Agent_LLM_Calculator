<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Калькулятор ресурсов для ЛЛМ-агентов (self-hosted) — v8</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.number-input{{text-align:right}}</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl font-bold">Калькулятор ресурсов для ЛЛМ-агентов</h1>
        <span class="text-xs px-2 py-1 rounded-full bg-violet-600 text-white">v8</span>
      </div>
      <div class="text-xs text-slate-500">Сборка: 2025-09-01 10:50</div>
    </header>

    <p class="text-sm text-slate-600 mb-4">Self-hosted оценка: GPU + базовые ресурсы (CPU, RAM, диск, сеть, серверы). Пояснение всегда видно ниже.</p>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <section class="bg-white rounded-2xl shadow p-5 xl:col-span-1">
        <h2 class="font-semibold mb-3">1) Что хотим посчитать</h2>
        <div class="space-y-3">
          <div>
            <label class="text-sm block mb-1">Тип задачи</label>
            <select id="preset_complexity" class="border rounded px-2 py-2 w-full">
              <option value="chat">Простой диалог</option>
              <option value="agent2" selected>Агент — 2 шага (поиск/инструменты)</option>
              <option value="agent5">Агент — 4–6 шагов (сложная задача)</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Одновременных пользователей</label><input id="concurrency" type="number" class="number-input border rounded px-2 py-1 w-full" value="100" min="1"></div>
            <div><label class="text-sm block mb-1">Среднее время ответа, сек</label><input id="latency" type="number" class="number-input border rounded px-2 py-1 w-full" value="3" min="1"></div>
          </div>
          <div>
            <label class="text-sm block mb-1">Производительность сервинга</label>
            <select id="perf_preset" class="border rounded px-2 py-2 w-full">
              <option value="base">Обычная (25 ток/с; batching 1.2)</option>
              <option value="opt" selected>Оптимизированная (80 ток/с; batching 1.6)</option>
            </select>
            <p class="text-xs text-slate-500 mt-1">Оптимизация: квантизация/высокоэффективный сервинг (vLLM, continuous batching).</p>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-5 xl:col-span-1">
        <h2 class="font-semibold mb-3">2) Модель и GPU-парк</h2>
        <div class="space-y-3">
          <div><label class="text-sm block mb-1">Модель</label>
            <select id="model_preset" class="border rounded px-2 py-2 w-full">
              <option value="7b">7B (лёгкая)</option>
              <option value="13b">13B (средняя)</option>
              <option value="34b">34B (тяжёлая)</option>
              <option value="70b" selected>70B (очень тяжёлая)</option>
            </select>
          </div>
          <div><label class="text-sm block mb-1">Квантование весов</label>
            <select id="quant" class="border rounded px-2 py-2 w-full">
              <option value="fp16">FP16/BF16</option>
              <option value="int8" selected>INT8</option>
              <option value="int4">4-бит</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Длина контекста (токенов)</label><input id="seq_len" type="number" class="number-input border rounded px-2 py-1 w-full" value="4096" min="512"></div>
            <div><label class="text-sm block mb-1">Одновременных запросов на 1 GPU (batch)</label><input id="batch" type="number" class="number-input border rounded px-2 py-1 w-full" value="4" min="1"></div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm block mb-1">Модель видеокарты</label>
              <select id="gpu_model" class="border rounded px-2 py-2 w-full">
                <option value="A100_80" selected>NVIDIA A100 80GB</option>
                <option value="H100_80">NVIDIA H100 80GB</option>
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Количество GPU (доступно)</label>
              <input id="gpu_available" type="number" class="number-input border rounded px-2 py-1 w-full" value="8" min="1">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Объём VRAM на карте (ГБ)</label>
              <select id="gpu_mem_cap" class="border rounded px-2 py-2 w-full"><option>24</option><option>40</option><option>48</option><option selected>80</option></select>
            </div>
            <div><label class="text-sm block mb-1">Цена 1 GPU, $/час</label><input id="gpu_price" type="number" class="number-input border rounded px-2 py-1 w-full" value="2.0" step="0.1"></div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">GPU на сервер (шт)</label><input id="gpus_per_server" type="number" class="number-input border rounded px-2 py-1 w-full" value="8" min="1"></div>
            <div><label class="text-sm block mb-1">Цена сервера, $/час (опц.)</label><input id="server_price" type="number" class="number-input border rounded px-2 py-1 w-full" value="0" step="0.1"></div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow p-5 xl:col-span-1">
        <h2 class="font-semibold mb-3">3) Базовые ресурсы</h2>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm block mb-1">RAG/поиск по своим данным</label>
              <select id="rag_enabled" class="border rounded px-2 py-2 w-full">
                <option value="no" selected>Нет</option>
                <option value="yes">Да</option>
              </select>
            </div>
            <div>
              <label class="text-sm block mb-1">Документов на шаг (k), если RAG</label>
              <input id="rag_k" type="number" class="number-input border rounded px-2 py-1 w-full" value="4" min="1">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Средний размер док-та, КБ</label><input id="rag_doc_kb" type="number" class="number-input border rounded px-2 py-1 w-full" value="200" min="1"></div>
            <div><label class="text-sm block mb-1">Размер эмбеддинга</label>
              <select id="embed_dim" class="border rounded px-2 py-2 w-full">
                <option value="384">384</option><option value="512">512</option><option value="768" selected>768</option><option value="1024">1024</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Число чанков в индексе</label><input id="rag_chunks" type="number" class="number-input border rounded px-2 py-1 w-full" value="500000" min="0"></div>
            <div><label class="text-sm block mb-1">Байт на число в индексе</label>
              <select id="rag_bytes" class="border rounded px-2 py-2 w-full"><option value="4" selected>float32 (4)</option><option value="2">float16 (2)</option></select>
            </div>
          </div>

          <hr class="my-2">
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">CPU на 1 GPU (рекомендация)</label>
              <select id="cpu_per_gpu" class="border rounded px-2 py-2 w-full">
                <option value="8">8 vCPU</option><option value="12" selected>12 vCPU</option><option value="16">16 vCPU</option>
              </select>
            </div>
            <div><label class="text-sm block mb-1">RAM на 1 GPU</label>
              <select id="ram_per_gpu" class="border rounded px-2 py-2 w-full">
                <option value="16">16 ГБ</option><option value="32" selected>32 ГБ</option><option value="64">64 ГБ</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm block mb-1">Логи/кэш на день, ГБ</label><input id="logs_gb_day" type="number" class="number-input border rounded px-2 py-1 w-full" value="20" min="0"></div>
            <div><label class="text-sm block mb-1">Срок хранения логов, дней</label><input id="logs_retention" type="number" class="number-input border rounded px-2 py-1 w-full" value="14" min="0"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="mt-6 bg-white rounded-2xl shadow p-5">
      <h2 class="font-semibold mb-4">Результаты</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Токены на задачу</div><div id="t_task_out" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Задач в секунду (RPS)</div><div id="rps_out" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Нужный токенный поток (TPS)</div><div id="tps_out" class="text-2xl font-semibold">—</div></div>

        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">VRAM веса (GB)</div><div id="vram_weights" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">VRAM под контекст (KV) (GB)</div><div id="vram_kv" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Итого VRAM на 1 GPU (GB)</div><div id="vram_total" class="text-2xl font-semibold">—</div></div>

        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Влезает в выбранную карту?</div><div id="fit_flag" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Нужно GPU (шт)</div><div id="gpu_needed" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Есть GPU (шт)</div><div id="gpu_have" class="text-2xl font-semibold">—</div></div>

        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">CPU всего (vCPU)</div><div id="cpu_total" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">RAM всего (GB)</div><div id="ram_total" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Диск (индекс+веса+логи), GB</div><div id="disk_total" class="text-2xl font-semibold">—</div></div>

        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Сеть (RAG), Mbps</div><div id="net_mbps" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">Нужно серверов (шт)</div><div id="servers_needed" class="text-2xl font-semibold">—</div></div>
        <div class="p-4 rounded-xl bg-slate-50"><div class="text-xs text-slate-500">$/час (GPU) + $/час (сервера)</div><div id="costs_hour" class="text-2xl font-semibold">—</div></div>
      </div>
    </section>

    <section class="mt-6 bg-white rounded-2xl shadow p-5">
      <h2 class="font-semibold mb-2">Пояснение расчёта</h2>
      <pre id="explainText" class="whitespace-pre-wrap text-sm leading-relaxed"></pre>
    </section>

    <footer class="mt-6 text-xs text-slate-500">
      Эта сборка: v8 · 2025-09-01 10:50. Подсказка: значения можно вводить с запятой или точкой.
    </footer>
  </div>

<script>
const modelPresets={'7b':{paramsB:7,L:32,d:4096,tok16:35},'13b':{paramsB:13,L:80,d:5120,tok16:25},'34b':{paramsB:34,L:96,d:8192,tok16:18},'70b':{paramsB:70,L:80,d:12288,tok16:12}};
const complexity={chat:{steps:0,sys:100,user:100,per_step:0,final:150},agent2:{steps:2,sys:200,user:100,per_step:480,final:200},agent5:{steps:5,sys:250,user:120,per_step:500,final:220}};
const gpuPerfMult={'A100_80':1.0,'H100_80':1.8};
const gpuMemCap={'A100_80':80,'H100_80':80};

function perfFromPreset(preset, quant, gpuModel, perfPreset){
  const quantMult = quant==='fp16'?1:(quant==='int8'?1.5:2.0);
  const base = preset.tok16 * quantMult;
  const gpuMult = gpuPerfMult[gpuModel] || 1;
  const perfMult = (perfPreset==='opt')? (1.6/1.2) : 1;
  return base * gpuMult * perfMult;
}
function bytesPerParam(quant){return quant==='fp16'?2:(quant==='int8'?1:0.5);} 
function bytesKV(){return 2;}

function val(id){return document.getElementById(id).value;} 
function num(id){const v=val(id).trim().replace(',','.');return v===''?NaN:Number(v);} 
function fmt(n,d=0){if(!isFinite(n))return'—';return Number(n).toLocaleString('ru-RU',{maximumFractionDigits:d,minimumFractionDigits:d});}

function syncGpuMemCap(){
  const m=val('gpu_model');const cap=gpuMemCap[m];const sel=document.getElementById('gpu_mem_cap');
  for(let i=0;i<sel.options.length;i++){if(Number(sel.options[i].value)===cap){sel.selectedIndex=i;break;}}
}

function compute(){
  const cx=complexity[val('preset_complexity')]; const steps=cx.steps,t_sys=cx.sys,t_user=cx.user,per_step=cx.per_step,t_final=cx.final;
  const concurrency=num('concurrency'), latency=num('latency'); const rps=concurrency/latency;
  const t_task=t_sys+t_user+steps*per_step+t_final; const tps_needed=rps*t_task;

  const mp=modelPresets[val('model_preset')]; const quant=val('quant'); const seq_len=num('seq_len'); const batch=num('batch');
  const gpuModel=val('gpu_model'); const perfPreset=val('perf_preset');
  const tok_per_gpu=perfFromPreset(mp,quant,gpuModel,perfPreset);
  const bytes_w=bytesPerParam(quant); const bytes_kv=bytesKV();
  const vram_weights=mp.paramsB*1e9*bytes_w/(1024**3); const vram_kv=2*mp.L*mp.d*bytes_kv*seq_len*batch/(1024**3);
  const vram_total=(vram_weights+vram_kv)*1.2; const cap=Number(val('gpu_mem_cap')); const fit=vram_total<=cap?'Да':'Нет';
  const gpu_needed=Math.max(1,Math.ceil(tps_needed/(tok_per_gpu)));
  const gpu_have=num('gpu_available');

  const cpu_per_gpu=Number(val('cpu_per_gpu')); const ram_per_gpu=Number(val('ram_per_gpu'));
  const cpu_total=gpu_needed*cpu_per_gpu; const ram_total=gpu_needed*ram_per_gpu;

  const rag_enabled=val('rag_enabled')==='yes'; const k=Number(num('rag_k')||0); const doc_kb=Number(num('rag_doc_kb')||0);
  const embed_dim=Number(val('embed_dim')); const chunks=Number(num('rag_chunks')||0); const rag_bytes=Number(val('rag_bytes'));
  const rag_index_gb=rag_enabled?(chunks*embed_dim*rag_bytes/(1024**3)):0; const rag_net_mbps=rag_enabled?(rps*k*doc_kb*8/1024):0;
  const logs_gb_day=Number(num('logs_gb_day')||0); const logs_retention=Number(num('logs_retention')||0); const logs_total_gb=logs_gb_day*logs_retention;
  const disk_total=vram_weights+rag_index_gb+logs_total_gb;

  const gpus_per_server=Number(num('gpus_per_server')||1); const servers_needed=Math.max(1,Math.ceil(gpu_needed/gpus_per_server));
  const gpu_price=Number(num('gpu_price')||0); const server_price=Number(num('server_price')||0);
  const cost_gpu_hour=gpu_needed*gpu_price; const cost_srv_hour=servers_needed*server_price; const cost_total_hour=cost_gpu_hour+cost_srv_hour;

  return {steps,t_sys,t_user,per_step,t_final,concurrency,latency,rps,t_task,tps_needed,mp,quant,seq_len,batch,gpuModel,perfPreset,tok_per_gpu,
          vram_weights,vram_kv,vram_total,cap,fit,gpu_needed,gpu_have,cpu_total,ram_total,rag_enabled,rag_index_gb,rag_net_mbps,disk_total,
          gpus_per_server,servers_needed,cost_gpu_hour,cost_srv_hour,cost_total_hour};
}

function render(){
  const v=compute();
  document.getElementById('t_task_out').textContent=fmt(v.t_task,0);
  document.getElementById('rps_out').textContent=fmt(v.rps,2);
  document.getElementById('tps_out').textContent=fmt(v.tps_needed,0);
  document.getElementById('vram_weights').textContent=fmt(v.vram_weights,2);
  document.getElementById('vram_kv').textContent=fmt(v.vram_kv,2);
  document.getElementById('vram_total').textContent=fmt(v.vram_total,2);
  document.getElementById('fit_flag').textContent=v.fit;
  document.getElementById('gpu_needed').textContent=fmt(v.gpu_needed,0);
  document.getElementById('gpu_have').textContent=fmt(v.gpu_have,0);
  document.getElementById('cpu_total').textContent=fmt(v.cpu_total,0);
  document.getElementById('ram_total').textContent=fmt(v.ram_total,0);
  document.getElementById('disk_total').textContent=fmt(v.disk_total,2);
  document.getElementById('net_mbps').textContent=fmt(v.rag_net_mbps,2);
  document.getElementById('servers_needed').textContent=fmt(v.servers_needed,0);
  document.getElementById('costs_hour').textContent=fmt(v.cost_total_hour,2);
  const fitBox=document.getElementById('fit_flag').parentElement; fitBox.classList.remove('bg-rose-100','bg-emerald-100'); fitBox.classList.add(v.fit==='Да'?'bg-emerald-100':'bg-rose-100');
  document.getElementById('explainText').textContent=explanationText(v);
}

function explanationText(v){
  const a=[];
  a.push('Нагрузка: RPS = пользователи / время = '+v.concurrency+' / '+v.latency+' = '+v.rps.toFixed(2)+' задач/сек.');
  a.push('Токены на задачу (по профилю) ≈ '+Math.round(v.t_task)+'. Поток = RPS × токены = '+Math.round(v.tps_needed)+' ток/сек.'); a.push('');
  a.push('GPU: скорость 1 GPU ≈ '+Math.round(v.tok_per_gpu)+' ток/сек → нужно GPU = ceil('+Math.round(v.tps_needed)+' / '+Math.round(v.tok_per_gpu)+') = '+v.gpu_needed+'.');
  a.push('Память на 1 GPU: веса '+v.vram_weights.toFixed(2)+' GB + KV '+v.vram_kv.toFixed(2)+' GB → всего '+v.vram_total.toFixed(2)+' GB → влезает: '+v.fit+'.'); a.push('');
  a.push('База: CPU всего ~ '+v.cpu_total+' vCPU, RAM всего ~ '+v.ram_total+' GB.');
  a.push('Диск ≈ веса модели ('+v.vram_weights.toFixed(2)+' GB) + индекс ('+(v.rag_enabled ? v.rag_index_gb.toFixed(2) : 0)+' GB) + логи = '+v.disk_total.toFixed(2)+' GB.');
  a.push('Сеть (если RAG) ≈ '+v.rag_net_mbps.toFixed(2)+' Mbps.');
  a.push('Серверы: при '+document.getElementById('gpus_per_server').value+' GPU/сервер → '+v.servers_needed+' сервер(ов).');
  a.push('Бюджет/час: GPU ~ '+v.cost_gpu_hour.toFixed(2)+' $ + серверы ~ '+v.cost_srv_hour.toFixed(2)+' $ = '+v.cost_total_hour.toFixed(2)+' $.');
  a.push('Рычаги: уменьшить контекст; кэшировать; квантовать сильнее; улучшить batching/serving; сократить шаги агента.');
  return a.join('\n');
}
document.getElementById('gpu_model').addEventListener('change',()=>{syncGpuMemCap();render();});
document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input',render));
syncGpuMemCap(); render();
</script>
</body>
</html>
